{% extends "app_management/base_management.html" %}
{% block page_title %}
  考題列表
{% endblock page_title %}
{% block page_content %}
  <div class="container mt-2">
    <h4>考題維護</h4>
    <form method="GET" action="{% url 'problem_list' %}">
      <div class="row mb-3">
        <div class="col-md-3">
          <label for="problem_id_search" class="form-label">考題編號搜尋</label>
          <input type="text"
                 class="form-control"
                 id="problem_id_search"
                 name="problem_id"
                 placeholder="輸入考題編號"
                 value="{{ problem_id_search|default:'' }}">
        </div>
        <div class="col-md-3">
          <label for="title_search" class="form-label">題目文字搜尋</label>
          <input type="text"
                 class="form-control"
                 id="title_search"
                 name="title_search"
                 placeholder="輸入題目關鍵字"
                 value="{{ title_search|default:'' }}">
        </div>
        <div class="col-md-3">
          <label for="language_filter" class="form-label">語言選擇</label>
          <select class="form-select" id="language_filter" name="language_filter">
            <option value="">全部語言</option>
            {% for language in languages %}
              <option value="{{ language.id }}" {% if language_filter == language.id|stringformat:"s" %}selected{% endif %}>
                {{ language.name }}
              </option>
            {% endfor %}
          </select>
        </div>
      </div>
      <div class="mb-3">
        <label class="form-label">題目主題分類</label>
        <div id="categories">
          <div class="row">
            {% for category in categories %}
              <div class="col">
                <div class="form-check">
                  <input class="form-check-input"
                         type="checkbox"
                         name="selected_categories"
                         value="{{ category.name }}"
                         id="category{{ category.id }}"
                         {% if category.name in selected_categories %}checked{% endif %} />
                  <label class="form-check-label" for="category{{ category.id }}">{{ category.name }}</label>
                </div>
              </div>
            {% endfor %}
          </div>
        </div>
      </div>
      <div class="mb-3">
        <button type="submit" class="btn btn-primary">過濾題目</button>
        <a href="{% url 'problem_list' %}" class="btn btn-secondary">搜尋復原</a>
      </div>
    </form>
    <table class="table table-striped">
      <thead>
        <tr>
          <th scope="col">id</th>
          <th scope="col">題目主題</th>
          <th scope="col">語言</th>
          <th scope="col">標題(點選進入:管理者提交考題測試)</th>
          <th scope="col">隸屬競賽(點選進入:競賽題目維護)</th>
          <th scope="col">考題管理功能</th>
        </tr>
      </thead>
      <tbody>
        {% for problem in problems %}
          <tr>
            <td>{{ problem.id }}</td>
            <td>
              <small>
                {% for category in problem.categories.all %}
                  {{ category.name }}
                  {% if not forloop.last %},{% endif %}
                {% empty %} 未分類
                {% endfor %}
              </small>
            </td>
            <td>
              <small>{{ problem.language }}</small>
            </td>
            <td>
              <a href="{% url 'problem_submit' problem.pk %}">{{ problem.title }}</a>
            </td>
            <td>
              <small>
                {% for contest in problem.contests.all %}
                  <a href="{% url 'contest_problems_manage' contest.pk %}">{{ contest.title }},</a>
                {% endfor %}
              </small>
            </td>
            <td>
              <a type="button"
                 class="btn btn-sm btn-warning"
                 href="{% url 'problem_update' problem.pk %}"
                 target="_blank">修改</a>
              {% comment %} 注意這裡頁次名稱改為 prblm_page_num 避免與problem_belongs_to頁面的 contests paginator 的 page 衝突 {% endcomment %}
              <a type="button"
                 class="btn btn-sm btn-info"
                 href="{% url 'problem_belongs_to' problem.pk %}?prblm_page_num={{ problems.number }}{% for category in selected_categories %}&selected_categories={{ category }}{% endfor %}{% if problem_id_search %}&problem_id={{ problem_id_search }}{% endif %}{% if title_search %}&title_search={{ title_search }}{% endif %}{% if language_filter %}&language_filter={{ language_filter }}{% endif %}">+競賽</a>
              <a type="button"
                 class="btn btn-sm btn-success"
                 href="{% url 'problem_duplicate' problem.pk %}?page={{ problems.number }}{% for category in selected_categories %}&selected_categories={{ category }}{% endfor %}{% if problem_id_search %}&problem_id={{ problem_id_search }}{% endif %}{% if title_search %}&title_search={{ title_search }}{% endif %}{% if language_filter %}&language_filter={{ language_filter }}{% endif %}">複製</a>
              <a type="button"
                 class="btn btn-sm btn-danger delete_this"
                 href="{% url 'problem_delete' problem.pk %}?page={{ problems.number }}{% for category in selected_categories %}&selected_categories={{ category }}{% endfor %}{% if problem_id_search %}&problem_id={{ problem_id_search }}{% endif %}{% if title_search %}&title_search={{ title_search }}{% endif %}{% if language_filter %}&language_filter={{ language_filter }}{% endif %}"
                 data-title="{{ problem.title }}">Del</a>
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
    {% if problems.paginator.num_pages > 1 %}
      <nav aria-label="Page navigation">
        <ul class="pagination">
          {% if problems.has_previous %}
            <li class="page-item">
              <a class="page-link"
                 href="?page=1{% for category in selected_categories %}&selected_categories={{ category }}{% endfor %}{% if problem_id_search %}&problem_id={{ problem_id_search }}{% endif %}{% if title_search %}&title_search={{ title_search }}{% endif %}{% if language_filter %}&language_filter={{ language_filter }}{% endif %}"
                 aria-label="First">
                <span aria-hidden="true">&laquo;&laquo;</span>
              </a>
            </li>
            <li class="page-item">
              <a class="page-link"
                 href="?page={{ problems.previous_page_number }}{% for category in selected_categories %}&selected_categories={{ category }}{% endfor %}{% if problem_id_search %}&problem_id={{ problem_id_search }}{% endif %}{% if title_search %}&title_search={{ title_search }}{% endif %}{% if language_filter %}&language_filter={{ language_filter }}{% endif %}"
                 aria-label="Previous">
                <span aria-hidden="true">&laquo;</span>
              </a>
            </li>
          {% endif %}
          {% for num in problems.paginator.page_range %}
            <li class="page-item {% if problems.number == num %}active{% endif %}">
              <a class="page-link"
                 href="?page={{ num }}{% for category in selected_categories %}&selected_categories={{ category }}{% endfor %}{% if problem_id_search %}&problem_id={{ problem_id_search }}{% endif %}{% if title_search %}&title_search={{ title_search }}{% endif %}{% if language_filter %}&language_filter={{ language_filter }}{% endif %}">{{ num }}</a>
            </li>
          {% endfor %}
          {% if problems.has_next %}
            <li class="page-item">
              <a class="page-link"
                 href="?page={{ problems.next_page_number }}{% for category in selected_categories %}&selected_categories={{ category }}{% endfor %}{% if problem_id_search %}&problem_id={{ problem_id_search }}{% endif %}{% if title_search %}&title_search={{ title_search }}{% endif %}{% if language_filter %}&language_filter={{ language_filter }}{% endif %}"
                 aria-label="Next">
                <span aria-hidden="true">&raquo;</span>
              </a>
            </li>
            <li class="page-item">
              <a class="page-link"
                 href="?page={{ problems.paginator.num_pages }}{% for category in selected_categories %}&selected_categories={{ category }}{% endfor %}{% if problem_id_search %}&problem_id={{ problem_id_search }}{% endif %}{% if title_search %}&title_search={{ title_search }}{% endif %}{% if language_filter %}&language_filter={{ language_filter }}{% endif %}"
                 aria-label="Last">
                <span aria-hidden="true">&raquo;&raquo;</span>
              </a>
            </li>
          {% endif %}
        </ul>
      </nav>
    {% endif %}
  </div>
  <script>
  $(".delete_this").click(function () {
    var title = $(this).data("title");
    var result = window.confirm('確定刪除? "' + title + '"');
    if (result == false) {
      //e.preventDefault();
      return false;
    }
  });
  </script>
{% endblock page_content %}
