{% extends "app_management/base_management.html" %}
{% block page_title %}
    匯出考題
{% endblock page_title %}
{% block page_content %}
    <div class="col-12 mt-2">
        <!-- 標題 -->
        <h4 class="mb-3">匯出考題(匯出部分考題，也可至Admin資料庫管理者畫面，選取import-export)</h4>
        
        <form method="POST" action="{% url 'export_problems_to_excel' %}" id="exportForm">
            {% csrf_token %}
            <div id="hiddenInputs"></div>
            
            <!-- 操作按鈕區 -->
            <div class="d-flex justify-content-between align-items-center mb-3 p-3 bg-light border rounded">
                <div>
                    <button type="button" class="btn btn-info me-2" onclick="selectAll()">
                        <i class="fas fa-check-square"></i> 全選本頁
                    </button>
                    <button type="button" class="btn btn-warning me-2" onclick="clearAll()">
                        <i class="fas fa-times-circle"></i> 清除本頁
                    </button>
                    <button type="button" class="btn btn-danger me-2" onclick="clearAllPages()">
                        <i class="fas fa-trash"></i> 清除所有勾選
                    </button>
                    <span class="badge bg-primary ms-2" id="selectedCount">已選: 0 題</span>
                </div>
                <div>
                    <button type="submit" class="btn btn-success btn-lg">
                        <i class="fas fa-download"></i> 確定匯出
                    </button>
                </div>
            </div>
            
            <table class="table">
                <thead>
                    <tr>
                        <th scope="col">id</th>
                        <th scope="col">題目主題</th>
                        <th scope="col">標題</th>
                        <th scope="col">隸屬競賽</th>
                        <th scope="col">勾選題目</th>
                    </tr>
                </thead>
                <tbody>
                    {% for problem in problems %}
                        <tr>
                            <td>{{ problem.id }}</td>
                            <td>
                                <small>
                                    {% for category in problem.categories.all %}
                                        {{ category.name }}
                                        {% if not forloop.last %},{% endif %}
                                    {% empty %}
                                        未分類
                                    {% endfor %}
                                </small>
                            </td>
                            <td>{{ problem.title }}</td>
                            <td>
                                <small>
                                    {% for contest in problem.contests.all %}{{ contest.title }},{% endfor %}
                                </small>
                            </td>
                            <td>
                                <div class="form-check">
                                    <input class="form-check-input problem-checkbox"
                                           type="checkbox"
                                           name="problem_exported"
                                           value="{{ problem.pk }}"
                                           data-problem-id="{{ problem.pk }}"
                                           onchange="updateSelection(this)">
                                </div>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </form>
        {% if problems.has_other_pages %}
            <ul class="pagination">
                {% if problems.has_previous %}
                    <li>
                        <a href="?page={{ problems.previous_page_number }}">&laquo;</a>
                    </li>
                {% else %}
                    <li class="disabled">
                        <span>&laquo;</span>
                    </li>
                {% endif %}
                {% for i in problems.paginator.page_range %}
                    {% if problems.number == i %}
                        <li class="active">
                            <span>{{ i }}, <span class="sr-only">(current)</span></span>
                        </li>
                    {% else %}
                        <li>
                            <a href="?page={{ i }}">{{ i }},</a>
                        </li>
                    {% endif %}
                {% endfor %}
                {% if problems.has_next %}
                    <li>
                        <a href="?page={{ problems.next_page_number }}">&raquo;</a>
                    </li>
                {% else %}
                    <li class="disabled">
                        <span>&raquo;</span>
                    </li>
                {% endif %}
            </ul>
        {% endif %}
    </div>
{% endblock page_content %}

{% block script_block %}
<script>
    // 使用 sessionStorage 保存跨頁勾選狀態
    const STORAGE_KEY = 'selected_problems';

    // 獲取已選擇的題目 IDs
    function getSelectedProblems() {
        const stored = sessionStorage.getItem(STORAGE_KEY);
        return stored ? JSON.parse(stored) : [];
    }

    // 保存已選擇的題目 IDs
    function saveSelectedProblems(selectedIds) {
        sessionStorage.setItem(STORAGE_KEY, JSON.stringify(selectedIds));
        updateSelectedCount();
    }

    // 更新選擇狀態
    function updateSelection(checkbox) {
        let selectedIds = getSelectedProblems();
        const problemId = checkbox.value;

        if (checkbox.checked) {
            // 添加到選擇列表
            if (!selectedIds.includes(problemId)) {
                selectedIds.push(problemId);
            }
        } else {
            // 從選擇列表移除
            selectedIds = selectedIds.filter(id => id !== problemId);
        }

        saveSelectedProblems(selectedIds);
    }

    // 全選本頁
    function selectAll() {
        const checkboxes = document.querySelectorAll('.problem-checkbox');
        let selectedIds = getSelectedProblems();

        checkboxes.forEach(checkbox => {
            checkbox.checked = true;
            const problemId = checkbox.value;
            if (!selectedIds.includes(problemId)) {
                selectedIds.push(problemId);
            }
        });

        saveSelectedProblems(selectedIds);
    }

    // 清除本頁
    function clearAll() {
        const checkboxes = document.querySelectorAll('.problem-checkbox');
        let selectedIds = getSelectedProblems();

        checkboxes.forEach(checkbox => {
            checkbox.checked = false;
            const problemId = checkbox.value;
            selectedIds = selectedIds.filter(id => id !== problemId);
        });

        saveSelectedProblems(selectedIds);
    }

    // 清除所有勾選
    function clearAllPages() {
        if (confirm('確定要清除所有已勾選的題目嗎？')) {
            sessionStorage.removeItem(STORAGE_KEY);
            document.querySelectorAll('.problem-checkbox').forEach(checkbox => {
                checkbox.checked = false;
            });
            updateSelectedCount();
        }
    }

    // 更新已選數量顯示
    function updateSelectedCount() {
        const selectedIds = getSelectedProblems();
        document.getElementById('selectedCount').textContent = `已選: ${selectedIds.length} 題`;
    }

    // 頁面載入時恢復勾選狀態
    function restoreSelections() {
        const selectedIds = getSelectedProblems();
        document.querySelectorAll('.problem-checkbox').forEach(checkbox => {
            if (selectedIds.includes(checkbox.value)) {
                checkbox.checked = true;
            }
        });
        updateSelectedCount();
    }

    // 表單提交前，將所有選擇的 ID 添加到隱藏欄位
    function prepareFormSubmit(event) {
        event.preventDefault();
        
        const selectedIds = getSelectedProblems();
        
        if (selectedIds.length === 0) {
            alert('請至少選擇一題');
            return false;
        }

        // 移除所有 checkbox 的 name 屬性，避免重複提交
        document.querySelectorAll('.problem-checkbox').forEach(checkbox => {
            checkbox.removeAttribute('name');
        });

        // 清空隱藏欄位容器
        const hiddenInputsContainer = document.getElementById('hiddenInputs');
        hiddenInputsContainer.innerHTML = '';

        // 為每個選擇的 ID 創建隱藏的 input
        selectedIds.forEach(id => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'problem_exported';
            input.value = id;
            hiddenInputsContainer.appendChild(input);
        });

        // 提交表單
        document.getElementById('exportForm').submit();
        
        // 提交後清除選擇
        sessionStorage.removeItem(STORAGE_KEY);
    }

    // 頁面載入完成後執行
    document.addEventListener('DOMContentLoaded', function() {
        restoreSelections();
        
        // 綁定表單提交事件
        document.getElementById('exportForm').addEventListener('submit', prepareFormSubmit);
    });
</script>
{% endblock script_block %}
