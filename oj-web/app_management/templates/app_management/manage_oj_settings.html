{% extends "app_management/base_management.html" %}
{% block page_title %}
  ç³»çµ±è¨­å®šèˆ‡è€ƒè©¦ç®¡ç†
{% endblock page_title %}
{% block page_content %}
  <div class="row mt-2 mb-5">
    <h3>ç³»çµ±è¨­å®šèˆ‡ä¸Šæ©Ÿè€ƒè©¦ç®¡ç†(System Settings and Conntest Management)</h3>
    <label>å¯¦é«”ä¸Šæ©Ÿè€ƒæ™‚ï¼Œå¿…é ˆè¨­å®šä»¥ä¸‹ç®¡åˆ¶(å»ºè­°å¯ä»¥å…¨éƒ¨é–‹å•Ÿ)ã€‚è€ƒè©¦è€ƒå®Œè¨˜å¾—æ¢å¾©åŸå§‹è¨­å®šã€‚</label>
  </div>
  <div class="row mb-2">
    <label class="form-label d-block">*ä¸Šæ©Ÿè€ƒé–‹å§‹å‰å‹™å¿…è¦åšä¸€æ¬¡æ¸…æƒï¼è®“è€ƒç”Ÿåœ¨ä»–è™•å·²ç¶“æœ‰çš„ç™»å…¥å¤±æ•ˆã€‚è‹¥ä½¿ç”¨è€…å¯†ç¢¼äº‹å…ˆæœ‰è¢«ä¿®æ”¹,é‚£éº¼ä»–ä¹‹å‰çš„ç™»å…¥ä¹Ÿæœƒè‡ªå‹•å¤±æ•ˆã€‚</label>
    <div class="d-flex">
      <button type="submit"
              id="btn_delete_sessions"
              class="btn btn-sm btn-danger me-2">-->æ¸…ç†Sessionç´€éŒ„ï¼Œè®“æ‰€æœ‰è€ƒç”Ÿå…ˆå‰çš„ç™»å…¥å¤±æ•ˆ(åšä¸€æ¬¡å³å¯ï¼Œè‹¥æœ‰è®Šæ›´å¯†ç¢¼å¯ä¸å¿…æ¸…ç†)</button>
    </div>
  </div>
  <div class="row mt-5 mb-2">
    <div class="form-check form-switch">
      <input class="form-check-input"
             type="checkbox"
             id="switchLoginIP"
             name="darkmode"
             value="true"
             style="width: 3rem; height: 1.5rem; cursor: pointer; margin-right: 1rem;" />
      <label class="fw-bold fs-5" style="color: #ff4757; background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; text-shadow: 0 0 20px rgba(255, 71, 87, 0.3);">
        <i class="fas fa-exclamation-triangle me-2" style="color: #ff4757;"></i>åœæ­¢ä»»ä½•äººç™»å…¥(ç®¡ç†è€…é™¤å¤–)ï¼Œæˆ–åªå…è¨±ä»¥ä¸‹IPç™»å…¥
      </label>
    </div>
    <input type="text" value="" id="ipranges" class="form-control m-input mt-2" />
  </div>
  <div class="row mt-2 mb-2">
    <label class="form-label d-block">*ç©ºç™½ä¸å¯«ä»»ä½•IPï¼Œé™¤äº†ç®¡ç†è€…ä¹‹å¤–ï¼Œä»»ä½•äººéƒ½ç„¡æ³•ç™»å…¥</label>
    <label class="form-label d-block">
      *åªå…è¨±åœ¨æ­¤æ•™å®¤IPç™»å…¥ï¼Œå…¶é¤˜IPç„¡æ³•ç™»å…¥ï¼Œå¯é˜²æ­¢å¤–éƒ¨ä»£è€ƒè€…ã€‚
    </label>
    <label class="form-label d-block">
      *ç”¨é€—è™Ÿåˆ†éš”å¤šå€‹IPï¼Œä¾‹å¦‚:163.18.22.222(å¯ä»¥å¤šçµ„ï¼Œç”¨é€—è™Ÿåˆ†éš”)æˆ–æ˜¯ä¸€ç¾¤163.18.22.0/24, 163.18.0.0/16
    </label>
    <label class="form-label d-block">*è‹¥æœ‰ä¿®æ”¹IPæˆ–æ–°å¢IP,è«‹å†æ¬¡é—œé–‰radioæŒ‰éˆ•ï¼Œå†æ‰“é–‹ï¼Œæ‰èƒ½ç«‹åˆ»ç”Ÿæ•ˆ!</label>
  </div>
  <div class="row mt-2 mb-2">
    <label class="form-label d-block">*å¾®è»ŸDocker Desktopçš„é è¨­IP:172.18.0.1ç„¡æ³•ç®¡åˆ¶IP</label>
  </div>
  <div class="row mt-2 mb-2">
    <label class="form-label d-block">*é›»è…¦æ•™å®¤è‹¥æœ‰é›»è…¦æ•…éšœä¸å¤ ç”¨,å¯äº‹å…ˆè«‹æœ€å„ªç§€çš„å¹¾ä½å­¸ç”Ÿç”¨è‡ªå·±çš„ç­†é›»ä¾†æ‡‰è€ƒ,æ›¿ä»–é–‹æ”¾IP,å¯åœ¨'è¢«æ‹’çµ•IPçš„è€ƒç”Ÿ'ä¸­æŸ¥çœ‹å…¶IP</label>
  </div>
  <div class="row mt-5 mb-5">
    <div class="form-check form-switch">
      <input class="form-check-input"
             type="checkbox"
             id="switchSingleLogin"
             name="darkmode"
             value="true" />
      <label class="form-check-label">åªå…è¨±è€ƒç”Ÿæœ‰ä¸€å€‹ç™»å…¥ï¼Œæ›å€‹ç€è¦½å™¨ã€æ›é›»è…¦å†ç™»å…¥ï¼Œå‰ä¸€å€‹ç™»å…¥æœƒè¢«è¸¢å‡ºã€‚</label>
      <label class="form-check-label">è‹¥ä»£è€ƒè€…ç”±ä¸åŒé›»è…¦ç™»å…¥ï¼ŒåŸè€ƒç”Ÿçš„ç™»å…¥æœƒå¤±æ•ˆ(è¢«è¸¢å‡º)ï¼Œé€™æ¨£ç„¡æ³•å®Œå…¨é˜²æ­¢ä»£è€ƒï¼Œåªèƒ½å°å‡ºå¤šæ¬¡ç™»å…¥çš„è€ƒç”Ÿï¼Œå‘è©²ä½è€ƒç”ŸæŸ¥å•å…¶å¤šæ¬¡ç™»å…¥çš„åŸå› ï¼Œåœ¨è€ƒå ´ä¸ŠåŠ ä»¥é˜²æ­¢ã€‚</label>
    </div>
    <div class="form-check form-switch">
      <input class="form-check-input"
             type="checkbox"
             id="switchHideSubmittedCode"
             name="darkmode"
             value="true" />
      <label class="form-check-label">ç«¶è³½å°šæœªçµæŸï¼Œä¸é¡¯ç¤ºå·²ç¶“æäº¤æˆåŠŸçš„ç¨‹å¼ç¢¼ï¼Œæäº¤ä¸æˆåŠŸçš„ç¨‹å¼ç¢¼ä»æœƒé¡¯ç¤ºã€‚(å¸³è™Ÿæ´©æ¼çµ¦ä»–äººï¼Œä¹Ÿçœ‹ä¸åˆ°æäº¤çš„å·²æ¥å—ç­”æ¡ˆ)</label>
    </div>
    <div class="form-check form-switch">
      <input class="form-check-input"
             type="checkbox"
             id="switchAllowUserRegister"
             name="darkmode"
             value="true" />
      <label class="form-check-label">ç¦æ­¢æ–°ä½¿ç”¨è€…è¨»å†Š</label>
    </div>
    <div class="form-check form-switch">
      <input class="form-check-input"
             type="checkbox"
             id="switchDisablePasswordChange"
             name="darkmode"
             value="true" />
      <label class="form-check-label">ç¦æ­¢ä½¿ç”¨è€…è®Šæ›´å¯†ç¢¼</label>
    </div>
  </div>
  <div class="row mb-2">
    <div class="d-flex">
      <button type="submit"
              id="btn_display_abnormal_users"
              class="btn btn-sm btn-primary me-2">é¡¯ç¤ºè€ƒç”Ÿå¤šæ¬¡ç™»å…¥èˆ‡è¢«æ‹’çµ•IPæƒ…æ³(å†æŒ‰ä¸€æ¬¡åˆ·æ–°)</button>
      <button type="submit"
              id="btn_delete_abnormal_users"
              class="btn btn-sm btn-danger me-2">-->å…ˆæ¸…é™¤å‰ä¸€æ¬¡çš„è€ƒç”Ÿè¢«æ‹’çµ•IPèˆ‡å¤šæ¬¡ç™»å…¥ã€ç™»å…¥ç™»å‡ºç´€éŒ„ç­‰è³‡æ–™åº«çš„èˆŠç´€éŒ„(é€²è¡Œæ–°ä¸Šæ©Ÿè€ƒ)</button>
    </div>
  </div>
  <!-- é¡¯ç¤ºå€å¡Š-->
  <div class="col-lg-6 mb-2">
    <div class="card">
      <div class="card-header">
        <h3 class="h6 text-uppercase mb-0">è¢«æ‹’çµ•IPçš„è€ƒç”Ÿ(é–‹å•ŸIPç®¡åˆ¶æ‰æœƒé¡¯ç¤º)</h3>
      </div>
      <div class="card-body">
        <div class="row">
          <div id="display_rejected_ip_users"></div>
        </div>
      </div>
    </div>
  </div>
  <!-- å€å¡ŠçµæŸ-->
  <!-- é¡¯ç¤ºå€å¡Š-->
  <div class="col-lg-6 mb-2">
    <div class="card">
      <div class="card-header">
        <h3 class="h6 text-uppercase mb-0">æœ‰å¤šæ¬¡ç™»å…¥çš„è€ƒç”Ÿ(å¯¦é«”è€ƒè©¦æ™‚é ˆæŸ¥è©¢æ˜¯å¦æœ‰ä»£è€ƒçš„æƒ…æ³)</h3>
      </div>
      <div class="card-body">
        <div class="row">
          <div id="display_multiple_session_users"></div>
        </div>
      </div>
    </div>
  </div>
  <!-- å€å¡ŠçµæŸ-->

   <div class="row mt-5 mb-3">
    <h5>æŸ¥è©¢æœªåˆ°å­¸ç”Ÿ(å°šæœªç™»å…¥çš„å­¸ç”Ÿ)</h5>
    <label class="form-label d-block">å¯ä»¥é¸å¡«ç­ç´šå’Œæ™‚é–“é»ï¼ŒæŸ¥è©¢è©²æ™‚é–“é»å¾Œå°šæœªç™»å…¥çš„å­¸ç”Ÿã€‚è‹¥æœªå¡«å¯«æ™‚é–“é»å‰‡é»˜èªç‚ºç•¶ä¸‹æ™‚é–“ä¹‹å‰3å€‹å°æ™‚ã€‚</label>
  </div>
  <div class="row mb-3">
    <div class="col-md-3">
      <label for="queryClass" class="form-label">ç­ç´š(é¸å¡«)</label>
      <input type="text" 
             class="form-control m-input" 
             id="queryClass" 
             placeholder="ä¾‹å¦‚ï¼š1A, 2B" />
    </div>
    <div class="col-md-4">
      <label for="queryTime" class="form-label">æŸ¥è©¢æ™‚é–“é»(é¸å¡«ï¼Œæ ¼å¼ï¼šYYYY-MM-DD HH:mm)</label>
      <input type="text" 
             class="form-control m-input" 
             id="queryTime" 
             placeholder="ä¾‹å¦‚ï¼š2024-10-25 14:30" />
    </div>
    <div class="col-md-3">
      <label>&nbsp;</label>
      <button type="button"
              id="btn_query_no_login_users"
              class="btn btn-sm btn-success w-100">æŸ¥è©¢æœªåˆ°å­¸ç”Ÿ(å†æŒ‰ä¸€æ¬¡åˆ·æ–°)</button>
    </div>
  </div>
  <!-- é¡¯ç¤ºå€å¡Š-->
  <div class="col-lg-6 mb-2">
    <div class="card">
      <div class="card-header">
        <h3 class="h6 text-uppercase mb-0">æ²’æœ‰ç™»å…¥çš„è€ƒç”Ÿ</h3>
      </div>
      <div class="card-body">
        <div class="row">
          <div id="display_no_login_users"></div>
        </div>
      </div>
    </div>
  </div>
  <!-- å€å¡ŠçµæŸ-->

    <!-- é¡¯ç¤ºå€å¡Š-->
  <div class="col-lg-6 mb-2">
    <div class="card">
      <div class="card-header">
        <h3 class="h6 text-uppercase mb-0">ç™»å…¥ç™»å‡ºç´€éŒ„</h3>
      </div>
      <div class="card-body">
        <div class="row">
          <div id="display_login_logout_records"></div>
        </div>
      </div>
    </div>
  </div>
  <!-- å€å¡ŠçµæŸ-->

{% endblock page_content %}
{% block script_block %}
  <script>
  load_sys_options();

  function load_sys_options() {
    jQuery.ajax({
      type: "GET",
      url: "/manage/sys_options/",
      data: {
        csrfmiddlewaretoken: "{{ csrf_token }}",
      }, //pass to server
      success: function (response) {
        console.log(response);

        $("#switchLoginIP").attr(
          "checked",
          response["forbid_login_ip"] == "True"
        );

        //$("#switchLoginIP").prop("checked", sysOptions['allow_login_ip']===true);
        $(ipranges).val(response["allowed_ip_ranges"]);

        $("#switchSingleLogin").attr(
          "checked",
          response["forbid_login_session"] == "True"
        );

        $("#switchDisablePasswordChange").attr(
          "checked",
          response["forbid_password_change"] == "True"
        );
        $("#switchAllowUserRegister").attr(
          "checked",
          response["allow_user_register"] == "False"
        );

        $("#switchHideSubmittedCode").attr(
          "checked",
          response["hide_submitted_code"] == "True"
        );

        //æ³¨æ„:å›å‚³çš„boolæ˜¯å­—ä¸²ï¼Œä¸æ˜¯js bool
      }, //success function
    }); //ajax
  }

  // Function to handle AJAX request
  function sendAjaxRequest() {
    // Update the values based on the current state of the radio buttons
    $("#switchLoginIP").val(
      $("#switchLoginIP").prop("checked") ? "True" : "False"
    );
    $("#switchSingleLogin").val(
      $("#switchSingleLogin").prop("checked") ? "True" : "False"
    );
    $("#switchDisablePasswordChange").val(
      $("#switchDisablePasswordChange").prop("checked") ? "True" : "False"
    );
    $("#switchAllowUserRegister").val(
      $("#switchAllowUserRegister").prop("checked") ? "False" : "True"
    );
    $("#switchHideSubmittedCode").val(
      $("#switchHideSubmittedCode").prop("checked") ? "True" : "False"
    );

    jQuery.ajax({
      type: "POST",
      url: "/manage/sys_options/",
      data: {
        forbid_login_ip: $("#switchLoginIP").val(),
        forbid_login_session: $("#switchSingleLogin").val(),
        allowed_ip_ranges: $("#ipranges").val(),
        forbid_password_change: $("#switchDisablePasswordChange").val(),
        allow_user_register: $("#switchAllowUserRegister").val(),
        hide_submitted_code: $("#switchHideSubmittedCode").val(),
        csrfmiddlewaretoken: "{{ csrf_token }}",
      }, //pass to server
      success: function (response) {
        console.log(response);
        load_sys_options();
      }, //success function
    }); //ajax
  }

  // Event listener for #switchLoginIP
  $("#switchLoginIP").on("change", function () {
    if ($(this).is(":checked")) {
      $(this).attr("value", "True");
      alert("åªæœ‰å¡«å…¥çš„ç‰¹å®šIPæ‰å¯ç™»å…¥ï¼Œè‹¥æ²’æœ‰å¡«å…¥IPå‰‡ä»»ä½•ä½¿ç”¨è€…çš†ä¸å…è¨±ç™»å…¥!");
    } else {
      $(this).attr("value", "False");
      alert("è§£é™¤IPç®¡åˆ¶ï¼Œä»»ä½•åœ°é»çš„é›»è…¦IPéƒ½å¯ç™»å…¥");
    }
    sendAjaxRequest();
  });

  // Event listener for #switchSingleLogin
  $("#switchSingleLogin").on("change", function () {
    if ($(this).is(":checked")) {
      $(this).attr("value", "True");
      alert($(this).val() + "ä¸€å€‹è€ƒç”Ÿåªèƒ½æ“æœ‰ä¸€å€‹ç™»å…¥session");
    } else {
      $(this).attr("value", "False");
      alert("å¯åœ¨ä¸åŒç€è¦½å™¨æˆ–ä»–å°é›»è…¦å¤šæ¬¡ç™»å…¥");
    }
    sendAjaxRequest();
  });

  // Event listener for #switchDisablePasswordChange
  $("#switchDisablePasswordChange").on("change", function () {
    if ($(this).is(":checked")) {
      $(this).attr("value", "True");
      alert($(this).val() + "ä½¿ç”¨è€…ä¸å¯ä¿®æ”¹å¯†ç¢¼");
    } else {
      $(this).attr("value", "False");
      alert("å…è¨±ä½¿ç”¨è€…ä¿®æ”¹å¯†ç¢¼");
    }
    sendAjaxRequest();
  });
  // Event listener for #switchAllowUserRegister
  $("#switchAllowUserRegister").on("change", function () {
    if ($(this).is(":checked")) {
      $(this).attr("value", "True");
      alert($(this).val() + "ç¦æ­¢æ–°ä½¿ç”¨è€…è¨»å†Š");
    } else {
      $(this).attr("value", "False");
      alert("å…è¨±æ–°ä½¿ç”¨è€…è¨»å†Š");
    }
    sendAjaxRequest();
  });

  // Event listener for #switchHideSubmittedCode
  $("#switchHideSubmittedCode").on("change", function () {
    if ($(this).is(":checked")) {
      $(this).attr("value", "True");
      alert($(this).val() + "ç«¶è³½å°šæœªçµæŸï¼Œéš±è—æäº¤æˆåŠŸçš„ç¨‹å¼ç¢¼");
    } else {
      $(this).attr("value", "False");
      alert("ç«¶è³½é€²è¡Œä¸­ï¼Œé è¨­é¡¯ç¤ºæäº¤çš„ç¨‹å¼ç¢¼");
    }
    sendAjaxRequest();
  });
  /*
$(".form-check-input").on("change", function () {

  //
  if ($("#switchLoginIP").is(":checked")) {
    $("#switchLoginIP").attr("value", "True");
    alert("é–‹å•Ÿé™åˆ¶ç‰¹å®šIPç™»å…¥");
  } else {
    $("#switchLoginIP").attr("value", "False");
    alert("é—œé–‰é™åˆ¶ç‰¹å®šIPç™»å…¥");
  }

  //
  if ($("#switchSingleLogin").is(":checked")) {
    $("#switchSingleLogin").attr("value", "True");
    //alert($(this).val() + ":é™åˆ¶åªèƒ½åœ¨æ•™å®¤ç™»å…¥");
  } else {
    $("#switchSingleLogin").attr("value", "False");
    //alert("æ³¨æ„:å¯åœ¨ä¸åŒç€è¦½å™¨æˆ–ä»–å°é›»è…¦å¤šæ¬¡ç™»å…¥ï¼Œç„¡æ³•é˜²æ­¢ä»£è€ƒè€…ç™»å…¥");
  }

  //
  if ($("#switchDisablePasswordChange").is(":checked")) {
    $("#switchDisablePasswordChange").attr("value", "True");
    //alert($(this).val() + ":ç¦æ­¢ä½¿ç”¨è€…ä¿®æ”¹å¯†ç¢¼");
  } else {
    $("#switchDisablePasswordChange").attr("value", "False");
    //alert("æ³¨æ„:å…è¨±ä½¿ç”¨è€…ä¿®æ”¹å¯†ç¢¼");
  }
  //
  if ($("#switchHideSubmittedCode").is(":checked")) {
    $("#switchHideSubmittedCode").attr("value", "True");
    //alert($(this).val() + ":ç¦æ­¢ä½¿ç”¨è€…ä¿®æ”¹å¯†ç¢¼");
  } else {
    $("#switchHideSubmittedCode").attr("value", "False");
    //alert("æ³¨æ„:ç«¶è³½å°šæœªçµæŸï¼Œä¹Ÿè¦é¡¯ç¤ºæäº¤çš„ç¨‹å¼ç¢¼");
  }
  
  jQuery.ajax({
    type: "POST",
    url: "/manage/sys_options/",
    data: {
      forbid_login_ip: $("#switchLoginIP").val(),
      forbid_login_session: $("#switchSingleLogin").val(),
      allowed_ip_ranges: $("#ipranges").val(),
      forbid_password_change: $("#switchDisablePasswordChange").val(),
      hide_submitted_code: $("#switchHideSubmittedCode").val(),
      csrfmiddlewaretoken: "{{ csrf_token }}",
    }, //pass to server
    success: function (response) {
      console.log(response);
      load_sys_options();
    }, //success function
  }); //ajax
});
*/
  $("#btn_display_abnormal_users").on("click", function () {
    jQuery.ajax({
      type: "POST",
      url: "/manage/get_abnormal_users/",
      data: {
        csrfmiddlewaretoken: "{{ csrf_token }}",
      }, //pass to server
      success: function (response) {
        data_ip_rejected = response["ip_rejected_users"];
        data_session_warning = response["session_warning_users"];

        $("#display_rejected_ip_users").empty();
        if (data_ip_rejected.length === 0) {
          $("#display_rejected_ip_users").append("<span>ç„¡ç´€éŒ„</span>");
        } else {
          let text = "";
          for (let i = 0; i < data_ip_rejected.length; i++) {
            text += data_ip_rejected[i]["username"] + ",";
            text += data_ip_rejected[i]["full_name"] + ",";
            text += data_ip_rejected[i]["ip"] + ",";
            text += data_ip_rejected[i]["created_at"] + "<br>";
          }
          $("#display_rejected_ip_users").append(text);
        }

        $("#display_multiple_session_users").empty();
        if (data_session_warning.length === 0) {
          $("#display_multiple_session_users").append("<span>ç„¡ç´€éŒ„</span>");
        } else {
          let text2 = "";
          for (let i = 0; i < data_session_warning.length; i++) {
            text2 += data_session_warning[i]["username"] + ",";
            text2 += data_session_warning[i]["full_name"] + ",";
            text2 += data_session_warning[i]["ip"] + ",";
            text2 += data_session_warning[i]["created_at"] + "<br>";
          }
          $("#display_multiple_session_users").append(text2);
        }
        
        // é¡¯ç¤ºç™»å…¥ç™»å‡ºç´€éŒ„
        displayLoginLogoutRecords();
      }, //success function
    }); //ajax
  });

  // é¡¯ç¤ºç™»å…¥ç™»å‡ºç´€éŒ„
  function displayLoginLogoutRecords() {
    jQuery.ajax({
      type: "GET",
      url: "/manage/get_login_logout_records/",
      data: {
        csrfmiddlewaretoken: "{{ csrf_token }}",
      },
      success: function (response) {
        $("#display_login_logout_records").empty();
        
        if (!response["login_records"] || response["login_records"].length === 0) {
          $("#display_login_logout_records").append("<span>ç„¡ç™»å…¥ç´€éŒ„</span>");
        } else {
          let text = "<strong>ç™»å…¥ç´€éŒ„ï¼š</strong><br>";
          for (let i = 0; i < response["login_records"].length; i++) {
            const record = response["login_records"][i];
            text += `${record["username"]},${record["full_name"]},${record["ip"]},${record["login_time"]}<br>`;
          }
          $("#display_login_logout_records").append(text);
        }
        
        if (response["logout_records"] && response["logout_records"].length > 0) {
          let text2 = "<br><strong>ç™»å‡ºç´€éŒ„ï¼š</strong><br>";
          for (let i = 0; i < response["logout_records"].length; i++) {
            const record = response["logout_records"][i];
            text2 += `${record["username"]},${record["full_name"]},${record["ip"]},${record["logout_time"]}<br>`;
          }
          $("#display_login_logout_records").append(text2);
        }
      },
      error: function (error) {
        console.log("ç²å–ç™»å…¥ç™»å‡ºç´€éŒ„å¤±æ•—:", error);
      }
    });
  }

  $("#btn_delete_abnormal_users").on("click", function () {
    let result = window.confirm("æ¸…é™¤ä½¿ç”¨è€…ç™»å…¥ç´€éŒ„?");
    if (result == false) {
      //e.preventDefault();
      return false;
    }
    jQuery.ajax({
      type: "POST",
      url: "/manage/delete_abnormal_users/",
      data: {
        csrfmiddlewaretoken: "{{ csrf_token }}",
      }, //pass to server
      success: function (response) {
        $("#display_rejected_ip_users").empty();
        $("#display_rejected_ip_users").append(response["message"]);
        $("#display_multiple_session_users").empty();
        $("#display_multiple_session_users").append(response["message"]);
        $("#display_login_logout_records").empty();
        $("#display_login_logout_records").append(response["message"]);
      }, //success function
    }); //ajax
  }); // btn_delete_abnormal_users

  $("#btn_delete_sessions").on("click", function () {
    let result = window.confirm("å°‡æ‰€æœ‰äººè¸¢å‡ºOJç³»çµ±?");
    if (result == false) {
      //e.preventDefault();
      return false;
    }
    jQuery.ajax({
      type: "POST",
      url: "/manage/delete_user_sessions/",
      data: {
        csrfmiddlewaretoken: "{{ csrf_token }}",
      }, //pass to server
      success: function (response) {
        //console.log(response)
        showMessage("å·²å°‡æ‰€æœ‰äººè¸¢å‡ºOJç³»çµ±ï¼", "text-success");
      }, //success function
    }); //ajax
  }); // btn_delete_sessions

  // æŸ¥è©¢æœªåˆ°å­¸ç”Ÿï¼ˆå°šæœªç™»å…¥çš„å­¸ç”Ÿï¼‰
  $("#btn_query_no_login_users").on("click", function () {
    let queryClass = $("#queryClass").val().trim();
    let queryTime = $("#queryTime").val().trim();
    
    // æª¢æŸ¥è¼¸å…¥çš„æ™‚é–“æ ¼å¼æ˜¯å¦æ­£ç¢º
    if (queryTime && !isValidDateTime(queryTime)) {
      showMessage("æ™‚é–“æ ¼å¼éŒ¯èª¤ï¼Œè«‹ä½¿ç”¨ YYYY-MM-DD HH:mm æ ¼å¼", "text-danger");
      return;
    }
    
    jQuery.ajax({
      type: "POST",
      url: "/manage/get_no_login_users/",
      data: {
        query_class: queryClass,
        query_time: queryTime,
        csrfmiddlewaretoken: "{{ csrf_token }}",
      },
      success: function (response) {
        console.log(response);
        
        $("#display_no_login_users").empty();
        
        if (response["no_login_users"].length === 0) {
          $("#display_no_login_users").append("<span style='color: green;'>ğŸ‰ æ‰€æœ‰å­¸ç”Ÿéƒ½å·²ç™»å…¥ï¼</span>");
        } else {
          let text = "";
          text += `<strong>æŸ¥è©¢æ¢ä»¶ï¼š</strong><br>`;
          if (queryClass) {
            text += `ç­ç´š: ${queryClass} | `;
          } else {
            text += `ç­ç´š: å…¨éƒ¨ | `;
          }
          if (queryTime) {
            text += `æ™‚é–“é»: ${queryTime}<br>`;
          } else {
            text += `æ™‚é–“é»: æœªæŒ‡å®š (é»˜èªç•¶ä¸‹æ™‚é–“ä¹‹å‰ä¸‰å€‹å°æ™‚)<br>`;
          }
          text += `<strong>æœªåˆ°å­¸ç”Ÿç¸½æ•¸: ${response["no_login_users"].length} äºº</strong><br><br>`;
          
          text += "<table class='table table-sm table-striped'>";
          text += "<thead><tr><th>å­¸è™Ÿ</th><th>å§“å</th><th>ç­ç´š</th><th>æœ€å¾Œç™»å…¥æ™‚é–“</th></tr></thead><tbody>";
          
          for (let i = 0; i < response["no_login_users"].length; i++) {
            const user = response["no_login_users"][i];
            text += `<tr>`;
            text += `<td>${user["username"]}</td>`;
            text += `<td>${user["full_name"]}</td>`;
            text += `<td>${user["user_class"]}</td>`;
            text += `<td>${user["last_login_time"] || "æœªç™»å…¥"}</td>`;
            text += `</tr>`;
          }
          
          text += "</tbody></table>";
          $("#display_no_login_users").append(text);
        }
        
        // é¡¯ç¤ºç™»å…¥ç™»å‡ºç´€éŒ„
        displayLoginLogoutRecords();
      },
      error: function (error) {
        console.log("æŸ¥è©¢å¤±æ•—:", error);
        showMessage("æŸ¥è©¢å¤±æ•—ï¼Œè«‹é‡è©¦", "text-danger");
      }
    });
  });
  
  // é©—è­‰æ—¥æœŸæ™‚é–“æ ¼å¼
  function isValidDateTime(dateTimeStr) {
    // æ ¼å¼ï¼šYYYY-MM-DD HH:mm
    const pattern = /^\d{4}-\d{2}-\d{2} \d{2}:\d{2}$/;
    if (!pattern.test(dateTimeStr)) {
      return false;
    }
    
    // é€²ä¸€æ­¥é©—è­‰æ—¥æœŸæ™‚é–“çš„æœ‰æ•ˆæ€§
    const parts = dateTimeStr.split(" ");
    const dateParts = parts[0].split("-");
    const timeParts = parts[1].split(":");
    
    const year = parseInt(dateParts[0]);
    const month = parseInt(dateParts[1]);
    const day = parseInt(dateParts[2]);
    const hour = parseInt(timeParts[0]);
    const minute = parseInt(timeParts[1]);
    
    if (month < 1 || month > 12) return false;
    if (day < 1 || day > 31) return false;
    if (hour < 0 || hour > 23) return false;
    if (minute < 0 || minute > 59) return false;
    
    return true;
  }
  </script>
{% endblock script_block %}
