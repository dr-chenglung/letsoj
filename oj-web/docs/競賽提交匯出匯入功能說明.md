# 競賽提交匯出匯入功能說明

## 📋 功能概述

已成功將原本的命令列工具整合到管理者網頁介面中，提供更友善的操作方式。

## 🎯 新增功能

### 1. 競賽提交匯出 (Export Contest Submissions)
**路徑**: `/manage/export_contest_submissions/`

**功能說明**:
- 匯出指定競賽的所有提交記錄和排名資料
- 自動打包成 ZIP 檔案下載
- 包含兩個 JSON 檔案：
  - `contest_export_submissions_{競賽編號}.json` - 提交記錄
  - `contest_export_ranks_{競賽編號}.json` - 排名資料

**使用方式**:
1. 進入「管理者首頁」
2. 點選導航列的「匯入匯出」→「競賽提交匯出」
3. 輸入競賽編號
4. 點擊「開始匯出」
5. 自動下載 ZIP 檔案

**匯出資料內容**:
- 提交記錄：提交者、題目ID、程式碼、評測結果、提交時間等
- 排名資料：提交者、提交數、AC數、總時間、詳細資訊等

---

### 2. 競賽提交匯入 (Import Contest Submissions)
**路徑**: `/manage/import_contest_submissions/`

**功能說明**:
- 從 JSON 檔案匯入競賽提交記錄和排名資料
- 支援批次匯入，自動更新已存在的資料
- 自動處理錯誤，跳過無法匯入的資料

**使用方式**:
1. 進入「管理者首頁」
2. 點選導航列的「匯入匯出」→「競賽提交匯入」
3. 輸入目標競賽編號
4. 上傳提交記錄 JSON 檔案
5. 上傳排名資料 JSON 檔案
6. 點擊「開始匯入」

**重要前提**:
- ⚠️ 目標競賽必須已存在於資料庫
- ⚠️ 所有相關題目必須已存在
- ⚠️ 所有相關使用者帳號必須已建立
- ⚠️ 若 ID 已存在，會更新該筆資料

---

## 🎨 界面特色

### 匯出頁面特色:
- 🎨 清晰的卡片式設計
- 📊 即時顯示匯出結果統計
- ⚠️ 側邊欄提供注意事項和常見問題
- ✅ 操作成功後顯示詳細訊息

### 匯入頁面特色:
- 📤 檔案上傳介面友善
- 🛡️ 詳細的前置檢查清單
- 📝 清楚的使用場景說明
- 🔍 匯入結果詳細統計（成功/失敗筆數）

---

## 🔧 技術實作

### 導航選單更新
**檔案**: `app_management/templates/app_management/base_management.html`

新增兩個選項到「匯入匯出」下拉選單：
```html
<li>
  <a class="dropdown-item" href="{% url 'export_contest_submissions' %}">
    <i class="fas fa-file-export" style="color: #fa709a;"></i> 競賽提交匯出
  </a>
</li>
<li>
  <a class="dropdown-item" href="{% url 'import_contest_submissions' %}">
    <i class="fas fa-file-upload" style="color: #feca57;"></i> 競賽提交匯入
  </a>
</li>
```

### 前端模板
**新增檔案**:
- `app_management/templates/app_management/export_contest_submissions.html`
- `app_management/templates/app_management/import_contest_submissions.html`

### 後端函數
**檔案**: `app_management/views.py`

新增兩個函數：
```python
@staff_member_required
def export_contest_submissions(request):
    """匯出競賽的提交記錄和排名資料"""
    # 讀取競賽資料
    # 打包成 ZIP 檔案
    # 提供下載
    
@staff_member_required
def import_contest_submissions(request):
    """從 JSON 檔案匯入競賽提交記錄和排名資料"""
    # 讀取上傳的 JSON 檔案
    # 驗證資料
    # 批次匯入資料庫
```

### URL 路由
**檔案**: `app_management/urls.py`

```python
path(
    "export_contest_submissions/",
    views.export_contest_submissions,
    name="export_contest_submissions",
),
path(
    "import_contest_submissions/",
    views.import_contest_submissions,
    name="import_contest_submissions",
),
```

---

## 📌 使用場景

1. **資料庫遷移**
   - 將競賽資料從舊系統遷移到新系統

2. **資料備份與還原**
   - 定期匯出重要競賽資料作為備份
   - 發生問題時可快速還原資料

3. **測試環境準備**
   - 將正式環境的競賽資料複製到測試環境

4. **競賽資料複製**
   - 在不同伺服器間複製競賽資料

---

## ⚙️ 與原命令列工具的差異

### 原工具 (命令列)
```bash
# 需要進入 Docker 容器
docker exec -it oj-web bash

# 執行 Python 腳本
python 1-export-contest-submission.py 255
python 2-import-contest-submission.py 255
```

### 新工具 (網頁介面)
- ✅ 直接在瀏覽器操作，無需登入伺服器
- ✅ 視覺化界面，操作更直觀
- ✅ 即時回饋，顯示詳細結果
- ✅ 自動打包下載，無需手動處理檔案
- ✅ 完整的錯誤處理和訊息提示
- ✅ 更安全（需要管理員權限）

---

## 🔐 權限控制

- 兩個功能都使用 `@staff_member_required` 裝飾器
- 只有管理員（is_staff=True）可以存取
- 非管理員會被重導向到登入頁面

---

## 📊 資料格式

### JSON 檔案範例

**contest_export_submissions_71.json**:
```json
[
  {
    "id": 1234,
    "submitted_by": "student01",
    "problem_id": 100,
    "source_code": "print('Hello World')",
    "judge_compile_output": "",
    "judge_status_description": "Accepted",
    "judge_status": "AC",
    "submitted_at": "2025-10-08T10:30:00+08:00"
  }
]
```

**contest_export_ranks_71.json**:
```json
[
  {
    "id": 567,
    "submitted_by": "student01",
    "submission_count": 10,
    "accepted_count": 8,
    "total_time": 3600,
    "submission_info": "{}"
  }
]
```

---

## 🎉 完成項目

✅ 在導航列「匯入匯出」選單新增兩個選項
✅ 建立匯出功能頁面和後端邏輯
✅ 建立匯入功能頁面和後端邏輯
✅ 添加 URL 路由
✅ 美化界面（圖示、色彩、卡片設計）
✅ 完整的錯誤處理和訊息提示
✅ 詳細的使用說明和提示

---

## 📝 後續可能的改進

- [ ] 支援批次匯出多個競賽
- [ ] 匯入前預覽資料
- [ ] 匯入進度條顯示
- [ ] 支援 Excel 格式匯出
- [ ] 定時自動備份功能

---

**建立日期**: 2025-10-08
**版本**: 1.0
